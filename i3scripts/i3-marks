#!/bin/bash
#

#
# Assign a 2 digit mark to a window.
#
numeric()
{
    # Generate a random 2 digit mark.  Reject and retry if it matches
    # an assigned mark. The retry loop takes more time as the number
    # of marked containers approaches 100.
    while : ; do
        id=$((10#$(date +%N) % 100))
        id=$(printf "%02d" "${id}")
        count=$(for m in $(i3-msg -t get_marks | grep '[0-9][0-9]' | sed 's/,/\ /g');
                do echo "${m}"; done | grep -c "${id}")
        if [ "${count}" -eq 0 ]; then break; fi
    done
    sleep 1 # No need for caller to wait for the window.
    windowid=$(printf "0x%x" "$(xdotool getwindowfocus)")
    i3-msg "[id=\"${windowid}\"] mark --toggle \"${id}\""
    i3-msg "[con_mark=\"${id}\"] focus"
}

#
# Mark the focused window with the command alias. Remove the same
# mark from other windows on the same workspace.
#
commandalias()
{
    cws=$(i3-msg -t get_workspaces | jq '.[] | .name,.focused' | \
              grep true -B1 | grep -v true)
    windowid=$(printf "0x%x" "$(xdotool getwindowfocus)")
    i3-msg "[id=\"${windowid}\"] mark --add --replace ${cws}"
}

#
# When the monitor indicates a window change, update the marks.
#
update()
{
    count="$(pgrep -c -f "i3-msg -t subscribe -m")"
    case "${count}" in
        (0)
            true
            ;;
        (1)
            pkill -f "i3-msg -t subscribe -m"
            ;;
        (*)
            echo "Too many i3-msg subscriptions!"
            return
            ;;
    esac
    # shellcheck disable=SC2034
    i3-msg -t subscribe -m '[ "window" ]' | \
        while read -r line ; do i3-marks commandalias; read -r line; read -r line; done
}

#
# Run the window changed monitor in a terminal of its own.
#
terminal()
{
    # Ensure a single running instance of the terminal.
    pkill -f 'urxvt -T Window Change Monitor'
    i3-msg 'exec urxvt -T "Window Change Monitor"'
    sleep 2
    # Run the updater inside the aforementioned terminal.
    # Use brute force and ignorance to get the job done.
    xdotool type --clearmodifiers 'i3-marks update'
    xdotool key --clearmodifiers Return
}

#
# Start here.
#

case "$1" in
    (numeric)
        numeric
        ;;
    (commandalias)
        commandalias
        ;;
    (update)
        update
        ;;
    (terminal)
        (terminal) &
        ;;
esac

#
# Done.
#
