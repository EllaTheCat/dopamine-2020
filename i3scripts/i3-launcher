#!/bin/bash
#
# i3-launcher
#


#
# Launch a program and register it.
#
# (1) four digit handle
# (2) mpv, vlc, ...
# (.) stream
#
start ()
{
    if [ "${2:0:1}" = "/" ]; then
        # Absolute paths can be detected reliably.
        # Allowing arbitrary programs is insecure.
        app="mpv"
        i3-msg "exec --no-startup-id ${app} ${*:2}"
    else
        app=$2
        i3-msg "exec --no-startup-id ${*:2}"
    fi
}

#
# Kill the oldest running instance of a media player.
# - Assume 'mpv' if the command omits the media player.
# - A simple TV channel zapper is the canonical use case.
#
# (1) four digit handle
# (2) mpv, vlc, ...
# (.) stream
#
stop_oldest ()
{
    # An mpv instance has 2 pids, often contiguous, (N,N+1), but I
    # have seen (N,N+2), hence separate kills.
    if [ "${2:0:1}" = "/" ]; then
        pid0="$(pgrep --oldest -f "mpv")"
        kill "${pid0}"
        pid1="$(pgrep --oldest -f "mpv")"
        kill "${pid1}"
    else
        pid0="$(pgrep --oldest -f "$2")"
        kill "${pid0}"
        pid1="$(pgrep --oldest -f "$2")"
        kill "${pid1}"
    fi
}

#
# Start here.
#

# (1) start|stop
# (2) four digit handle
# (3) mpv, vlc, ...
# (.) stream

case "$1" in
    (start)
        start "$2" "$3" "${@:4}"
        ;;
    (stop_oldest)
        stop_oldest "$2" "$3" "${@:4}"
        ;;
    (stop_handle)
        stop_handle "$2" "$3" "${@:4}"
        ;;
esac

#
# Done.
#
