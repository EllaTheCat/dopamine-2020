#!/bin/bash
#
# i3-dispatcher
#

#
# Forward the command to a dedicated function.
#
forward ()
{
    export PATH=${HOME}/local/bin:${PATH}
    case "$1" in
	([a-z][0-9])
            # Sent from command prompt.
	    nohup i3-focus-app-by-alias focus "$1"
	    ;;
	([a-z][a-z])
            # Sent from command prompt.
	    nohup i3-focus-app-by-alias focus "$1"
            ;;
        (clip|edit)
            # Sent from Tasker & AutoVoice.
            nohup i3-transcribe "${@}"
            ;;
        (start|stop)
            # Sent from Tasker & TVH plugin.
            nohup i3-launcher "${@}"
            ;;
        (interrupt)
            # I use this to overlay each of my screens with a specific
            # image when my phone is ringing. The user should supply
            # the code to be executed on the target inside Tasker.
            eval "${*:2}"
            ;;
	(*)
            # I think dmenu implies blocking so this will flash for a
            # few seconds only.
	    nomatchfound "$*"
	    ;;
    esac
}

# Error message handler.
nomatchfound ()
{
    echo "i3-dispatcher: No match found! \"$*\"" |
	 dmenu -b -fn "pango:DejaVu Sans 11"
    sleep 3s
    # This key event effects a timeout, but only if the user
    # hasn't dismissed the dmenu first. It isn't watertight.
    if [ "$(pgrep -c -af 'dmenu -b -fn pango:DejaVu Sans 11')" -eq 1 ]; then
	xdotool key --clearmodifiers  Escape
    fi
}

#
# Start here.
#

"$1" "$2" "${@:3}"

#
# Done.
#
